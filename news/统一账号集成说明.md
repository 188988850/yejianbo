# 金融前端系统 - 统一账号集成说明

## 📋 集成概述

本金融前端系统已完全集成主系统的统一账号体系，实现了以下核心功能：

### 🔐 统一认证机制
- **Session集成**: 使用主系统的 `$_SESSION['zid']` 用户认证
- **Cookie验证**: 兼容主系统的 `user_token` cookie认证机制  
- **权限继承**: 自动继承主系统的用户权限和VIP状态

### 💰 统一余额系统
- **余额字段**: 直接使用主系统 `shua_site.rmb` 字段
- **实时同步**: 购买、充值、VIP开通实时更新主系统余额
- **交易记录**: 所有交易记录到主系统 `shua_pay` 和 `shua_points` 表

### 👑 统一VIP体系
- **VIP状态**: 使用主系统 `shua_site.finance_vip` 字段
- **到期时间**: 使用主系统 `shua_site.finance_vip_expire` 字段
- **权限检查**: 自动识别VIP等级和权限

## 🗄️ 数据库结构

### 用户主表 (shua_site)
```sql
-- 核心字段
zid             INT         用户ID (主键)
user            VARCHAR     用户名
rmb             DECIMAL     账户余额
finance_vip     TINYINT     VIP等级 (0=普通,1=VIP1,2=VIP2,9=永久VIP)
finance_vip_expire DATETIME VIP到期时间
power           TINYINT     用户等级
status          TINYINT     用户状态 (1=正常,0=禁用)
```

### 订单表 (shua_pay)
```sql
-- 订单字段
trade_no        VARCHAR     订单号
type            VARCHAR     订单类型 (finance_resource,recharge,vip)
zid             INT         用户ID
tid             INT         资源ID
name            VARCHAR     订单名称
money           DECIMAL     订单金额
num             INT         购买数量
status          TINYINT     订单状态 (0=待支付,1=已完成)
addtime         DATETIME    创建时间
endtime         DATETIME    完成时间
```

### 余额记录表 (shua_points)
```sql
-- 余额变动记录
zid             INT         用户ID
action          VARCHAR     操作类型
point           DECIMAL     变动金额
bz              VARCHAR     备注说明
orderid         VARCHAR     关联订单号
addtime         DATETIME    记录时间
status          TINYINT     记录状态
```

### 资源内容表 (shua_finance_content)
```sql
-- 金融资源
id              INT         资源ID (主键)
name            VARCHAR     资源名称
description     TEXT        资源描述
price           DECIMAL     资源价格
category_id     INT         分类ID
status          TINYINT     状态 (1=上架,0=下架)
```

## 🔧 核心功能实现

### 1. 用户认证集成

```php
// 引入主系统认证
require_once dirname(__DIR__).'/includes/common.php';

// 检查登录状态
if(!isset($_SESSION['zid']) && !$islogin2) {
    header('Content-Type: application/json');
    echo json_encode(['code' => -1, 'msg' => '请先登录']);
    exit;
}

// 获取用户信息
$zid = intval($_SESSION['zid']);
$userrow = $DB->getRow("SELECT * FROM shua_site WHERE zid='{$zid}' AND status=1 LIMIT 1");
```

### 2. 余额操作集成

```php
// 扣除余额
$this->DB->exec("UPDATE shua_site SET rmb=rmb-{$totalPrice} WHERE zid='{$this->user['zid']}'");

// 记录余额变动
$this->DB->insert('points', [
    'zid' => $this->user['zid'],
    'action' => '购买金融资源',
    'point' => $totalPrice,
    'bz' => "购买资源: {$resource['name']} x{$quantity}",
    'orderid' => $orderNo,
    'addtime' => date('Y-m-d H:i:s'),
    'status' => 1
]);
```

### 3. VIP权限检查

```php
// 检查VIP状态
$this->isVip = ($this->user['finance_vip'] == 2 || $this->user['finance_vip'] == 9);

// VIP开通
$this->DB->exec("UPDATE shua_site SET finance_vip='{$vipType}', finance_vip_expire='{$newExpire}' WHERE zid='{$this->user['zid']}'");
```

## 🌐 前端界面特性

### 响应式设计
- **移动优先**: 完全适配手机、平板、桌面设备
- **现代UI**: 使用渐变背景、卡片布局、动画效果
- **直观导航**: 标签页式导航，清晰的功能分区

### 实时数据更新
- **用户信息**: 实时显示余额、VIP状态、用户等级
- **操作反馈**: 购买、充值、VIP开通即时反馈
- **数据同步**: 所有操作后自动刷新相关数据

### 友好交互体验
- **确认对话框**: 重要操作前的二次确认
- **状态提示**: 成功/失败状态的清晰提示
- **加载状态**: 数据加载时的友好提示

## 🔄 API接口说明

### 用户信息接口
```
GET /news/resourcemanager.php?action=user_info

Response:
{
    "code": 0,
    "data": {
        "zid": 123,
        "username": "testuser",
        "rmb": 1000.50,
        "is_vip": true,
        "vip_level": 2,
        "vip_expire": "2024-12-31 23:59:59",
        "power": 5,
        "status": 1
    }
}
```

### 购买资源接口
```
POST /news/resourcemanager.php
{
    "action": "buy",
    "resource_id": 1,
    "quantity": 2
}

Response:
{
    "code": 0,
    "msg": "购买成功",
    "data": {
        "order_no": "20241201123456789",
        "order_id": 123,
        "resource_name": "投资理财课程",
        "quantity": 2,
        "total_price": 50.00,
        "remaining_balance": 950.50
    }
}
```

### 充值接口
```
POST /news/resourcemanager.php
{
    "action": "recharge",
    "amount": 100.00,
    "pay_type": "alipay"
}

Response:
{
    "code": 0,
    "msg": "充值订单创建成功",
    "data": {
        "order_no": "CZ20241201123456789",
        "order_id": 124,
        "amount": 100.00,
        "pay_type": "alipay"
    }
}
```

### VIP开通接口
```
POST /news/resourcemanager.php
{
    "action": "open_vip",
    "vip_type": 2,
    "months": 3
}

Response:
{
    "code": 0,
    "msg": "VIP开通成功",
    "data": {
        "vip_type": 2,
        "expire_time": "2025-03-01 12:34:56",
        "order_no": "VIP20241201123456789"
    }
}
```

## 🛡️ 安全措施

### 数据验证
- **输入验证**: 所有用户输入都经过严格验证
- **参数过滤**: 防止SQL注入和XSS攻击
- **权限检查**: 每个操作都验证用户权限

### 事务处理
- **原子操作**: 所有涉及金额的操作使用数据库事务
- **回滚机制**: 操作失败时自动回滚，保证数据一致性
- **日志记录**: 详细记录所有操作日志便于追踪

### 错误处理
- **友好提示**: 用户友好的错误信息
- **详细日志**: 服务端详细的错误日志
- **异常捕获**: 完善的异常处理机制

## 📁 文件结构

```
news/
├── resourcemanager.php          # 后端API接口
├── resourcemanager.html         # 前端管理界面
├── api_userinfo.php            # 用户信息API
├── test_resource_manager.php    # 单元测试文件
└── 统一账号集成说明.md          # 本文档
```

## 🚀 部署说明

### 1. 文件部署
将 `news/` 目录下的文件上传到主系统的 `news/` 目录

### 2. 数据库准备
确保 `shua_finance_content` 表存在：
```sql
CREATE TABLE IF NOT EXISTS `shua_finance_content` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `name` varchar(255) NOT NULL COMMENT '资源名称',
    `description` text COMMENT '资源描述',
    `price` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '资源价格',
    `category_id` int(11) DEFAULT NULL COMMENT '分类ID',
    `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '状态 1=上架 0=下架',
    `addtime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '添加时间',
    PRIMARY KEY (`id`),
    KEY `idx_status` (`status`),
    KEY `idx_category` (`category_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='金融资源内容表';
```

### 3. 权限设置
确保 `news/` 目录有适当的读写权限

### 4. 访问测试
访问 `http://yourdomain.com/news/resourcemanager.html` 测试功能

## 🔍 测试验证

### 功能测试清单
- [ ] 用户登录状态检查
- [ ] 用户信息显示正确
- [ ] 资源列表加载正常
- [ ] 购买功能正常
- [ ] 余额扣除正确
- [ ] 订单记录正确
- [ ] VIP开通功能正常
- [ ] 充值功能正常
- [ ] 权限控制正确

### 运行单元测试
```bash
php news/test_resource_manager.php
```

## 🆘 故障排查

### 常见问题

1. **登录状态失效**
   - 检查 `$_SESSION['zid']` 是否存在
   - 验证主系统认证状态

2. **余额不同步**
   - 检查数据库连接
   - 验证事务是否正确提交

3. **VIP状态错误**
   - 检查 `finance_vip` 字段值
   - 验证 `finance_vip_expire` 时间

4. **接口返回错误**
   - 查看服务器错误日志
   - 检查PHP错误提示

### 调试模式
在 `resourcemanager.php` 顶部添加：
```php
error_reporting(E_ALL);
ini_set('display_errors', 1);
```

## 📞 技术支持

如遇到问题，请检查：
1. 主系统认证机制是否正常
2. 数据库表结构是否完整
3. 文件权限是否正确
4. PHP版本是否兼容

---

**系统版本**: v1.0  
**最后更新**: 2024-12-01  
**兼容性**: PHP 7.4+, MySQL 5.7+